# Minimal compose for in-container pen testing of agent-moltbook
# Usage: docker compose -f docker-compose.pentest.yml up -d
#        docker compose -f docker-compose.pentest.yml exec agent-moltbook bash

services:
  agent-moltbook:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        USER_UID: 1000
        USER_GID: 1000
    image: telclaude-pentest:latest
    container_name: pentest-agent-moltbook

    environment:
      - TELCLAUDE_AGENT_PORT=8789
      - TELCLAUDE_AGENT_WORKDIR=/moltbook/sandbox
      - TELCLAUDE_LOG_LEVEL=debug
      - MOLTBOOK_RPC_AGENT_PRIVATE_KEY=
      - MOLTBOOK_RPC_RELAY_PUBLIC_KEY=
      - TELCLAUDE_DATA_DIR=/home/node/.telclaude
      - TELCLAUDE_FIREWALL=1
      - TELCLAUDE_RUN_AS_ROOT=0
      - TELCLAUDE_INTERNAL_HOSTS=localhost
      - NODE_ENV=development
      # Simulate being in moltbook context
      - TELCLAUDE_MOLTBOOK_AGENT_WORKDIR=/moltbook/sandbox

    # Override entrypoint and command to just keep container running for manual testing
    entrypoint: ["/bin/sh", "-c"]
    command: ["echo 'Pen test container ready' && sleep infinity"]

    volumes:
      # Moltbook sandbox (the only writable workspace)
      - pentest-sandbox:/moltbook/sandbox:rw
      # Moltbook memory (read-only as per design)
      - pentest-memory:/moltbook/memory:ro
      # Simulate some sensitive data to try to access
      - pentest-fake-workspace:/workspace:ro

    user: "0:0"  # Start as root for firewall init, drops to 1000

    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - DAC_OVERRIDE
      - CHOWN
      - FOWNER
      - SETUID
      - SETGID

    security_opt:
      - no-new-privileges:true

    read_only: true
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /home/node:size=256M,mode=0755,uid=1000,gid=1000
      - /run/telclaude:size=1M,mode=0755

    mem_limit: 2G
    cpus: 2

    networks:
      - pentest-net

networks:
  pentest-net:
    driver: bridge

volumes:
  pentest-sandbox:
  pentest-memory:
  pentest-fake-workspace:
