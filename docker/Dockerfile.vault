# ═══════════════════════════════════════════════════════════════════════════════
# Telclaude Vault Daemon Sidecar
#
# Minimal container for running the credential vault daemon.
# Stores credentials encrypted at rest (AES-256-GCM) and communicates with
# the relay via Unix socket on a shared volume. Agents never see raw
# credentials - the relay's HTTP credential proxy injects them transparently.
#
# SECURITY:
# - No network access (internal-only network with no egress route)
# - No curl, git, or other utilities
# - Read-only root filesystem
# - Runs as non-root user (node)
# - All capabilities dropped
# ═══════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────────
# Stage 1: Builder
# ─────────────────────────────────────────────────────────────────────────────────
FROM node:22-bookworm-slim AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm via npm (corepack not available in all Node versions)
RUN npm install -g pnpm@9.15.0

WORKDIR /build

# Copy package files (including .npmrc for pnpm config)
COPY package.json pnpm-lock.yaml .npmrc ./

# Install dependencies
# --ignore-scripts prevents the "prepare" hook from running (which tries to build
# before source files are copied)
RUN pnpm install --ignore-scripts

# Copy source
COPY . .

# Build
RUN pnpm run build

# Rebuild native modules (they weren't compiled during install due to --ignore-scripts)
RUN pnpm rebuild

# Prune dev dependencies
# --ignore-scripts prevents the "prepare" hook from running (typescript already removed)
RUN pnpm prune --prod --ignore-scripts

# ─────────────────────────────────────────────────────────────────────────────────
# Stage 2: Runtime (Minimal)
# ─────────────────────────────────────────────────────────────────────────────────
FROM node:22-bookworm-slim AS runtime

LABEL org.opencontainers.image.title="telclaude-vault"
LABEL org.opencontainers.image.description="Credential vault daemon sidecar for telclaude"

# Modify the existing node user to match desired UID/GID
# The node base image already has a 'node' user with UID/GID 1000
# We use usermod/groupmod to adjust if needed (idiomatic Docker pattern)
# See: https://github.com/nodejs/docker-node/issues/289
ARG USER_UID=1000
ARG USER_GID=1000

RUN groupmod -g ${USER_GID} node \
    && usermod -u ${USER_UID} -g ${USER_GID} node \
    && mkdir -p /home/node/.telclaude/logs \
    && mkdir -p /data \
    && mkdir -p /run/vault \
    && chown -R node:node /home/node /data /run/vault

# Copy built application
WORKDIR /app
COPY --from=builder --chown=node:node /build/dist ./dist
COPY --from=builder --chown=node:node /build/node_modules ./node_modules
COPY --from=builder --chown=node:node /build/package.json ./
COPY --from=builder --chown=node:node /build/bin ./bin

# Environment
ENV NODE_ENV=production
ENV TELCLAUDE_DATA_DIR=/data
ENV TELCLAUDE_VAULT_SOCKET=/run/vault/vault.sock
ENV HOME=/home/node

# Switch to non-root user
USER node

# Healthcheck - verify socket exists (vault is healthy when socket is present)
HEALTHCHECK --interval=10s --timeout=5s --start-period=5s --retries=3 \
    CMD test -S /run/vault/vault.sock || exit 1

WORKDIR /data

ENTRYPOINT ["/app/bin/telclaude.js"]
CMD ["vault-daemon", "--socket", "/run/vault/vault.sock"]
