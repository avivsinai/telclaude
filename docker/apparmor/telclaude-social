#include <tunables/global>

# Telclaude Social Agent AppArmor profile
# Restricts the social agent container to its sandbox and memory paths.
# The social agent handles all social services (X/Twitter, Moltbook, etc.)
# and should never access the workspace, relay secrets, or auth tokens.

profile telclaude-social flags=(attach_disconnected,mediate_deleted) {
  # Basic allowances
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/ssl_certs>
  #include <abstractions/user-tmp>

  # Capabilities required for entrypoint (firewall, privilege drop, chown)
  capability net_admin,
  capability dac_override,
  capability chown,
  capability fowner,
  capability setuid,
  capability setgid,

  # Allow general file access; deny rules below take precedence.
  file,

  # Allow execution of system binaries/libraries
  /bin/** ix,
  /sbin/** ix,
  /usr/bin/** ix,
  /usr/sbin/** ix,
  /usr/local/bin/** ix,
  /lib/** mr,
  /lib64/** mr,
  /usr/lib/** mr,
  /usr/lib64/** mr,

  # App runtime
  /etc/alternatives/** ix,

  /app/** r,
  /app/bin/** ix,
  /app/node_modules/** mr,
  /app/dist/** mr,

  # Social sandbox (read/write - this is where the social agent works)
  /social/sandbox/** rwklix,

  # Social memory (read-only in social agent; relay is single writer)
  /social/memory/** r,
  deny /social/memory/** wklx,

  # Claude skills profile (shared)
  /home/telclaude-skills/** rwklix,

  # Config file (read-only)
  /data/telclaude.json r,

  # Deny workspace (social agent should never touch user projects)
  deny /workspace/** rwklx,

  # Deny relay auth secrets
  deny /home/telclaude-auth/** rwklx,

  # Deny relay data (SQLite, sessions)
  deny /data/*.db rwklx,
  deny /data/*.db-journal rwklx,
  deny /data/*.db-wal rwklx,

  # Deny vault and TOTP sockets
  deny /run/vault/** rwklx,
  deny /run/totp/** rwklx,

  # Deny media volumes (social agent doesn't use media)
  deny /media/** rwklx,

  # Block sensitive system paths
  deny /run/secrets/** rwklx,
  deny /var/run/secrets/** rwklx,

  # Block process environment/cmdline reads
  deny /proc/*/environ r,
  deny /proc/**/environ r,

  # Prevent tampering with system accounts
  deny /etc/shadow w,
  deny /etc/passwd w,

  # Temp + device nodes
  /tmp/** rwklix,
  /dev/null rw,
  /dev/urandom r,
  /dev/tty rw,

  # Network: allow standard traffic.
  # Note: iptables-nft requires netlink which AppArmor may classify under raw/packet.
  # Firewall enforcement is the primary network boundary; AppArmor restricts filesystem.
  network,
}
