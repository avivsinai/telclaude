#include <tunables/global>

# Telclaude Agent AppArmor profile
# Restricts the Telegram agent container to workspace and media paths.
# The agent runs Claude SDK tools and should only access the user's
# workspace - never relay secrets, auth tokens, or other containers' data.

profile telclaude-agent flags=(attach_disconnected,mediate_deleted) {
  # Basic allowances
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/ssl_certs>
  #include <abstractions/user-tmp>

  # Capabilities required for entrypoint (firewall, privilege drop, chown)
  capability net_admin,
  capability dac_override,
  capability chown,
  capability fowner,
  capability setuid,
  capability setgid,

  # Allow general file access; deny rules below take precedence.
  file,

  # Allow execution of system binaries/libraries
  /bin/** ix,
  /sbin/** ix,
  /usr/bin/** ix,
  /usr/sbin/** ix,
  /usr/local/bin/** ix,
  /lib/** mr,
  /lib64/** mr,
  /usr/lib/** mr,
  /usr/lib64/** mr,

  # App runtime
  /etc/alternatives/** ix,

  /app/** r,
  /app/bin/** ix,
  /app/node_modules/** mr,
  /app/dist/** mr,

  # Workspace (read/write - this is where Claude works)
  /workspace/** rwklix,

  # Claude skills profile (per-agent isolated volume)
  /home/telclaude-skills/** rwklix,

  # Deny social memory (telegram agent has no access â€” air-gap isolation)
  deny /social/memory/** rwklx,

  # Media volumes (read-only in agent)
  /media/inbox/** r,
  deny /media/inbox/** wklx,
  /media/outbox/** r,
  deny /media/outbox/** wklx,

  # Config file (read-only)
  /data/telclaude.json r,

  # Deny relay auth secrets
  deny /home/telclaude-auth/** rwklx,

  # Deny relay data (SQLite, sessions)
  deny /data/*.db rwklx,
  deny /data/*.db-journal rwklx,
  deny /data/*.db-wal rwklx,

  # Deny vault and TOTP sockets
  deny /run/vault/** rwklx,
  deny /run/totp/** rwklx,

  # Deny social sandbox (only social agent uses it)
  deny /social/sandbox/** rwklx,

  # Block sensitive system paths
  deny /run/secrets/** rwklx,
  deny /var/run/secrets/** rwklx,

  # Block process environment/cmdline reads
  deny /proc/*/environ r,
  deny /proc/**/environ r,

  # Prevent tampering with system accounts
  deny /etc/shadow w,
  deny /etc/passwd w,

  # Temp + device nodes
  /tmp/** rwklix,
  /dev/null rw,
  /dev/urandom r,
  /dev/tty rw,

  # Network: allow standard traffic.
  # Note: iptables-nft requires netlink which AppArmor may classify under raw/packet.
  # Firewall enforcement is the primary network boundary; AppArmor restricts filesystem.
  network,
}
