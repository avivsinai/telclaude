# ═══════════════════════════════════════════════════════════════════════════════
# Telclaude TOTP Daemon Sidecar
#
# Minimal container for running the TOTP daemon with encrypted file storage.
# Communicates with the main relay via Unix socket on a shared volume.
# ═══════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────────
# Stage 1: Builder
# ─────────────────────────────────────────────────────────────────────────────────
FROM node:25-bookworm-slim AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate

WORKDIR /build

# Copy package files (including .npmrc for pnpm config)
COPY package.json pnpm-lock.yaml .npmrc ./

# Install dependencies
# --ignore-scripts prevents the "prepare" hook from running (which tries to build
# before source files are copied)
RUN pnpm install --ignore-scripts

# Copy source
COPY . .

# Build
RUN pnpm run build

# Rebuild native modules (they weren't compiled during install due to --ignore-scripts)
RUN pnpm rebuild

# Prune dev dependencies
# --ignore-scripts prevents the "prepare" hook from running (typescript already removed)
RUN pnpm prune --prod --ignore-scripts

# ─────────────────────────────────────────────────────────────────────────────────
# Stage 2: Runtime (Minimal)
# ─────────────────────────────────────────────────────────────────────────────────
FROM node:25-bookworm-slim AS runtime

LABEL org.opencontainers.image.title="telclaude-totp"
LABEL org.opencontainers.image.description="TOTP daemon sidecar for telclaude"

# Modify the existing node user to match desired UID/GID
# The node base image already has a 'node' user with UID/GID 1000
# We use usermod/groupmod to adjust if needed (idiomatic Docker pattern)
# See: https://github.com/nodejs/docker-node/issues/289
ARG USER_UID=1000
ARG USER_GID=1000

RUN groupmod -g ${USER_GID} node \
    && usermod -u ${USER_UID} -g ${USER_GID} node \
    && mkdir -p /home/node/.telclaude/logs \
    && mkdir -p /data \
    && mkdir -p /run/totp \
    && chown -R node:node /home/node /data /run/totp

# Copy built application
WORKDIR /app
COPY --from=builder --chown=node:node /build/dist ./dist
COPY --from=builder --chown=node:node /build/node_modules ./node_modules
COPY --from=builder --chown=node:node /build/package.json ./
COPY --from=builder --chown=node:node /build/bin ./bin

# Environment
ENV NODE_ENV=production
ENV TELCLAUDE_DATA_DIR=/data
ENV TELCLAUDE_TOTP_SOCKET=/run/totp/totp.sock
ENV TOTP_STORAGE_BACKEND=file
ENV HOME=/home/node

# Switch to non-root user
USER node

# Healthcheck - verify socket exists
HEALTHCHECK --interval=10s --timeout=5s --start-period=5s --retries=3 \
    CMD test -S /run/totp/totp.sock || exit 1

WORKDIR /data

ENTRYPOINT ["/app/bin/telclaude.js"]
CMD ["totp-daemon"]
