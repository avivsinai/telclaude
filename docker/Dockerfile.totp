# ═══════════════════════════════════════════════════════════════════════════════
# Telclaude TOTP Daemon Sidecar
#
# Minimal container for running the TOTP daemon with encrypted file storage.
# Communicates with the main relay via Unix socket on a shared volume.
# ═══════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────────
# Stage 1: Builder
# ─────────────────────────────────────────────────────────────────────────────────
FROM node:22-bookworm-slim AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate

WORKDIR /build

# Copy package files (including .npmrc for pnpm config)
COPY package.json pnpm-lock.yaml .npmrc ./

# Install dependencies
# --ignore-scripts prevents the "prepare" hook from running (which tries to build
# before source files are copied)
RUN pnpm install --ignore-scripts

# Copy source
COPY . .

# Build
RUN pnpm run build

# Prune dev dependencies
# --ignore-scripts prevents the "prepare" hook from running (typescript already removed)
RUN pnpm prune --prod --ignore-scripts

# ─────────────────────────────────────────────────────────────────────────────────
# Stage 2: Runtime (Minimal)
# ─────────────────────────────────────────────────────────────────────────────────
FROM node:22-bookworm-slim AS runtime

LABEL org.opencontainers.image.title="telclaude-totp"
LABEL org.opencontainers.image.description="TOTP daemon sidecar for telclaude"

# Create non-root user
ARG USER_UID=1000
ARG USER_GID=1000

# Create user if it doesn't exist (node image already has UID/GID 1000)
# If UID 1000 exists, we reuse that user; otherwise create telclaude user
RUN if ! id -u ${USER_UID} >/dev/null 2>&1; then \
        groupadd --gid ${USER_GID} telclaude 2>/dev/null || true; \
        useradd --uid ${USER_UID} --gid ${USER_GID} -m -s /bin/bash telclaude; \
    fi \
    && mkdir -p /home/telclaude/.telclaude \
    && mkdir -p /data \
    && mkdir -p /run/totp \
    && chown -R ${USER_UID}:${USER_GID} /home/telclaude /data /run/totp

# Copy built application (use numeric UID/GID since user name might not exist)
WORKDIR /app
COPY --from=builder --chown=${USER_UID}:${USER_GID} /build/dist ./dist
COPY --from=builder --chown=${USER_UID}:${USER_GID} /build/node_modules ./node_modules
COPY --from=builder --chown=${USER_UID}:${USER_GID} /build/package.json ./
COPY --from=builder --chown=${USER_UID}:${USER_GID} /build/bin ./bin

# Environment
ENV NODE_ENV=production
ENV TELCLAUDE_DATA_DIR=/data
ENV TELCLAUDE_TOTP_SOCKET=/run/totp/totp.sock
ENV TOTP_STORAGE_BACKEND=file
ENV HOME=/home/telclaude

# Switch to non-root user (use numeric UID since user name might not exist)
USER 1000:1000

# Healthcheck - verify socket exists
HEALTHCHECK --interval=10s --timeout=5s --start-period=5s --retries=3 \
    CMD test -S /run/totp/totp.sock || exit 1

WORKDIR /data

ENTRYPOINT ["/app/bin/telclaude.js"]
CMD ["totp-daemon"]
