# ═══════════════════════════════════════════════════════════════════════════════
# Telclaude TOTP Daemon Sidecar
#
# Minimal container for running the TOTP daemon with encrypted file storage.
# Communicates with the main relay via Unix socket on a shared volume.
# ═══════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────────
# Stage 1: Builder
# ─────────────────────────────────────────────────────────────────────────────────
FROM node:22-bookworm-slim AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate

WORKDIR /build

# Copy package files
COPY package.json pnpm-lock.yaml ./

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source
COPY . .

# Build
RUN pnpm run build

# Prune dev dependencies
RUN pnpm prune --prod

# ─────────────────────────────────────────────────────────────────────────────────
# Stage 2: Runtime (Minimal)
# ─────────────────────────────────────────────────────────────────────────────────
FROM node:22-bookworm-slim AS runtime

LABEL org.opencontainers.image.title="telclaude-totp"
LABEL org.opencontainers.image.description="TOTP daemon sidecar for telclaude"

# Create non-root user
ARG USER_UID=1000
ARG USER_GID=1000

RUN groupadd --gid ${USER_GID} telclaude \
    && useradd --uid ${USER_UID} --gid ${USER_GID} -m -s /bin/bash telclaude \
    && mkdir -p /home/telclaude/.telclaude \
    && mkdir -p /data \
    && mkdir -p /run/totp \
    && chown -R telclaude:telclaude /home/telclaude /data /run/totp

# Copy built application
WORKDIR /app
COPY --from=builder --chown=telclaude:telclaude /build/dist ./dist
COPY --from=builder --chown=telclaude:telclaude /build/node_modules ./node_modules
COPY --from=builder --chown=telclaude:telclaude /build/package.json ./
COPY --from=builder --chown=telclaude:telclaude /build/bin ./bin

# Environment
ENV NODE_ENV=production
ENV TELCLAUDE_DATA_DIR=/data
ENV TELCLAUDE_TOTP_SOCKET=/run/totp/totp.sock
ENV TOTP_STORAGE_BACKEND=file
ENV HOME=/home/telclaude

# Switch to non-root user
USER telclaude

# Healthcheck - verify socket exists
HEALTHCHECK --interval=10s --timeout=5s --start-period=5s --retries=3 \
    CMD test -S /run/totp/totp.sock || exit 1

WORKDIR /data

ENTRYPOINT ["/app/bin/telclaude.js"]
CMD ["totp-daemon"]
