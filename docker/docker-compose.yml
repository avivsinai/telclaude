# ═══════════════════════════════════════════════════════════════════════════════
# Telclaude Docker Compose Configuration
#
# For Windows (WSL2) deployment with security hardening.
#
# Usage:
#   1. Copy .env.example to .env and fill in your values
#   2. Update WORKSPACE_PATH to point to your projects folder
#   3. docker compose up -d
#
# Security features:
#   - Privilege dropping via gosu (starts root, drops to UID 1000)
#   - Capability dropping (cap_drop: ALL, then add back only what's needed)
#   - Read-only root filesystem (with tmpfs for writes)
#   - Optional network firewall (requires root at startup, hence gosu pattern)
#   - Named volumes for persistence
#   - TOTP sidecar with encrypted file storage
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # Main Relay Service
  # ─────────────────────────────────────────────────────────────────────────────
  telclaude:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        USER_UID: 1000
        USER_GID: 1000
    image: telclaude:latest
    container_name: telclaude

    # Wait for TOTP daemon and agent to be ready
    depends_on:
      totp:
        condition: service_healthy
      telclaude-agent:
        condition: service_started

    environment:
      # Required: Telegram bot token
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN is required}

      # Optional: Anthropic API key (if not using claude login)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

      # Secrets storage encryption (reuses TOTP key for convenience)
      # Enables `telclaude setup-openai` and `telclaude setup-git`
      - SECRETS_ENCRYPTION_KEY=${SECRETS_ENCRYPTION_KEY:-${TOTP_ENCRYPTION_KEY}}
      # API keys (tier-based: auto-exposed for WRITE_LOCAL+, use setup-* commands or env vars)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GH_TOKEN=${GH_TOKEN:-}

      # Telclaude configuration
      - TELCLAUDE_CONFIG=/data/telclaude.json
      - TELCLAUDE_DATA_DIR=/data
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}
      - TELCLAUDE_AGENT_URL=http://telclaude-agent:8788
      - TELCLAUDE_CAPABILITIES_ENABLED=1
      - TELCLAUDE_INTERNAL_RPC_SECRET=${TELCLAUDE_INTERNAL_RPC_SECRET:?TELCLAUDE_INTERNAL_RPC_SECRET is required}
      - TELCLAUDE_GIT_PROXY_SECRET=${TELCLAUDE_GIT_PROXY_SECRET:-${TELCLAUDE_INTERNAL_RPC_SECRET}}
      - TELCLAUDE_MEDIA_INBOX_DIR=/media/inbox
      - TELCLAUDE_MEDIA_OUTBOX_DIR=/media/outbox

      # TOTP daemon socket (shared with sidecar)
      - TELCLAUDE_TOTP_SOCKET=/run/totp/totp.sock

      # SECURITY: Network firewall REQUIRED (Bash has no isolation without it)
      # Set TELCLAUDE_FIREWALL=1 in .env file (requires --cap-add=NET_ADMIN)
      - TELCLAUDE_FIREWALL=${TELCLAUDE_FIREWALL:-1}

      # Drop privileges after firewall init (gosu -> node user)
      # Docker mode: SDK sandbox disabled, container provides isolation
      - TELCLAUDE_RUN_AS_ROOT=0

      # Node environment
      - NODE_ENV=production

    volumes:
      # Persistent data (SQLite DB, sessions, config)
      - telclaude-data:/data:rw

      # Configuration file
      - ./telclaude.json:/data/telclaude.json:ro

      # Claude Code configuration (credentials, settings)
      - telclaude-claude:/home/node/.claude:rw

      # Shared socket for TOTP daemon communication
      - totp-socket:/run/totp:rw

      # Shared media volumes (inbox/outbox split)
      - media-inbox:/media/inbox:rw
      - media-outbox:/media/outbox:rw

    # Start as root for firewall init, then drop to node via gosu
    # Docker mode: SDK sandbox disabled, container provides isolation
    user: "0:0"

    # Explicit capability management (no privileged mode)
    # Note: Some kernels (e.g., Raspberry Pi OS) require explicit caps even for root
    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN   # Required for iptables firewall initialization
      - DAC_OVERRIDE  # Required for file access as root on some kernels
      - CHOWN       # Required for changing file ownership
      - FOWNER      # Required for bypassing ownership checks
      - SETUID      # Required for gosu privilege dropping
      - SETGID      # Required for gosu privilege dropping

    security_opt:
      - no-new-privileges:true

    read_only: true
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /home/node:size=256M,mode=0755
      - /run/telclaude:size=1M,mode=0755

    # Resource limits for non-Swarm Docker Compose (deploy.resources is Swarm-only)
    mem_limit: 4G
    cpus: 4

    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 512M

    networks:
      - agent-relay-net
      - relay-totp-net
      - relay-egress

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "telclaude", "provider-health", "--json"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ─────────────────────────────────────────────────────────────────────────────
  # Agent Worker (SDK + Tools, no secrets)
  # ─────────────────────────────────────────────────────────────────────────────
  telclaude-agent:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        USER_UID: 1000
        USER_GID: 1000
    image: telclaude:latest
    container_name: telclaude-agent


    environment:
      # Optional: Anthropic API key (if not using claude login)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

      # Agent server
      - TELCLAUDE_AGENT_PORT=8788
      - TELCLAUDE_AGENT_WORKDIR=/workspace
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}
      - TELCLAUDE_CONFIG=/data/telclaude.json

      # Relay capability broker
      - TELCLAUDE_CAPABILITIES_URL=http://telclaude:8790
      - TELCLAUDE_INTERNAL_RPC_SECRET=${TELCLAUDE_INTERNAL_RPC_SECRET:?TELCLAUDE_INTERNAL_RPC_SECRET is required}

      # Git proxy for secure git operations (token never exposed to agent)
      # The proxy intercepts git requests and adds authentication transparently
      - TELCLAUDE_GIT_PROXY_URL=http://telclaude:8791
      - TELCLAUDE_GIT_PROXY_SECRET=${TELCLAUDE_GIT_PROXY_SECRET:-${TELCLAUDE_INTERNAL_RPC_SECRET}}

      # Media paths (inbox/outbox split)
      - TELCLAUDE_MEDIA_INBOX_DIR=/media/inbox
      - TELCLAUDE_MEDIA_OUTBOX_DIR=/media/outbox

      # Data dir override (agent is stateless; uses tmpfs instead of /data volume)
      - TELCLAUDE_DATA_DIR=/home/node/.telclaude

      # SECURITY: Network firewall for tool egress control (Docker mode)
      - TELCLAUDE_FIREWALL=${TELCLAUDE_FIREWALL:-1}

      # Drop privileges after firewall init
      - TELCLAUDE_RUN_AS_ROOT=0

      - NODE_ENV=production

    command: ["agent", "-v"]

    volumes:
      # Workspace: Your projects folder (Claude works here)
      - ${WORKSPACE_PATH:?WORKSPACE_PATH is required}:/workspace:rw

      # Claude Code configuration (credentials, settings)
      - telclaude-claude:/home/node/.claude:rw

      # Configuration file (for provider allowlist + health checks)
      - ./telclaude.json:/data/telclaude.json:ro

      # Shared media volumes (inbox/outbox split)
      - media-inbox:/media/inbox:ro
      - media-outbox:/media/outbox:ro

    user: "0:0"

    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - DAC_OVERRIDE
      - CHOWN
      - FOWNER
      - SETUID
      - SETGID

    security_opt:
      - no-new-privileges:true

    read_only: true
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /home/node:size=256M,mode=0755,uid=1000,gid=1000
      - /run/telclaude:size=1M,mode=0755

    # Resource limits for non-Swarm Docker Compose (deploy.resources is Swarm-only)
    mem_limit: 4G
    cpus: 4

    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 512M

    networks:
      - agent-relay-net
      - agent-egress

    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────────────────────
  # TOTP Daemon Sidecar
  #
  # Handles 2FA operations with encrypted file storage.
  # Communicates with relay via Unix socket on shared volume.
  #
  # SECURITY: Network isolation enforced via internal-only network (relay-totp-net).
  # The TOTP container has NO external network connectivity - it only talks to relay
  # via the shared socket. No iptables/firewall needed since there's no egress route.
  # ─────────────────────────────────────────────────────────────────────────────
  totp:
    build:
      context: ..
      dockerfile: docker/Dockerfile.totp
      args:
        USER_UID: 1000
        USER_GID: 1000
    image: telclaude-totp:latest
    container_name: telclaude-totp

    environment:
      # Storage backend: file (encrypted) instead of keytar (OS keychain)
      - TOTP_STORAGE_BACKEND=file

      # Encryption key for TOTP secrets (REQUIRED)
      # Generate with: openssl rand -base64 32
      - TOTP_ENCRYPTION_KEY=${TOTP_ENCRYPTION_KEY:?TOTP_ENCRYPTION_KEY is required}

      # File paths
      - TOTP_SECRETS_FILE=/data/totp-secrets.json
      - TELCLAUDE_TOTP_SOCKET=/run/totp/totp.sock
      - TELCLAUDE_DATA_DIR=/data
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}

      - NODE_ENV=production

    volumes:
      # Persistent TOTP data (encrypted secrets file)
      - totp-data:/data:rw

      # Shared socket for relay communication
      - totp-socket:/run/totp:rw

    security_opt:
      - no-new-privileges:true

    user: "1000:1000"

    cap_drop:
      - ALL

    read_only: true
    tmpfs:
      - /tmp:size=64M,mode=1777
      - /home/node/.telclaude/logs:size=16M,mode=0755,uid=1000,gid=1000

    # Resource limits for non-Swarm Docker Compose (deploy.resources is Swarm-only)
    mem_limit: 128M
    cpus: 0.5

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M

    networks:
      - relay-totp-net

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "test", "-S", "/run/totp/totp.sock"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

# ═══════════════════════════════════════════════════════════════════════════════
# Named Volumes
#
# CRITICAL: Some volumes contain secrets that CANNOT be recovered if deleted.
# Run `docker/setup-volumes.sh` before first `docker compose up`.
# NEVER run `docker compose down -v` - it will delete all volumes!
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  # Main relay data: SQLite DB, sessions, identity links, approvals
  telclaude-data:
    name: telclaude-data

  # ┌─────────────────────────────────────────────────────────────────────────────┐
  # │ CRITICAL SECRETS - External volumes (protected from accidental deletion)   │
  # │ These must be pre-created: docker volume create <name>                      │
  # │ `docker compose down -v` CANNOT delete external volumes                     │
  # └─────────────────────────────────────────────────────────────────────────────┘

  # Claude Code credentials and settings (OAuth tokens)
  # Can be recreated via `claude login` but causes service interruption
  telclaude-claude:
    name: telclaude-claude
    external: true

  # TOTP daemon data: encrypted 2FA secrets
  # ⚠️  CANNOT BE RECOVERED IF DELETED - user must re-enroll all 2FA
  totp-data:
    name: telclaude-totp-data
    external: true

  # Shared Unix socket for relay ↔ TOTP communication
  # Uses tmpfs for better performance and automatic cleanup
  totp-socket:
    name: telclaude-totp-socket
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1M,uid=1000,gid=1000

  # Shared media inbox (agent RO, relay RW) - size capped
  media-inbox:
    name: telclaude-media-inbox
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=512M,uid=1000,gid=1000,mode=0700

  # Shared media outbox (relay RW, agent RO) - persistent for generated content
  media-outbox:
    name: telclaude-media-outbox

# ═══════════════════════════════════════════════════════════════════════════════
# Networks
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  agent-relay-net:
    name: telclaude-agent-relay
    driver: bridge
    internal: true

  relay-totp-net:
    name: telclaude-relay-totp
    driver: bridge
    internal: true

  agent-egress:
    name: telclaude-agent-egress
    driver: bridge

  relay-egress:
    name: telclaude-relay-egress
    driver: bridge
