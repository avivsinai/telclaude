# ═══════════════════════════════════════════════════════════════════════════════
# Telclaude Docker Compose Configuration
#
# For Windows (WSL2) deployment with security hardening.
#
# Usage:
#   1. Copy .env.example to .env and fill in your values
#   2. Update WORKSPACE_PATH to point to your projects folder
#   3. docker compose up -d
#
# Security features:
#   - Privilege dropping via gosu (starts root, drops to UID 1000)
#   - Capability dropping (cap_drop: ALL, then add back only what's needed)
#   - Read-only root filesystem (with tmpfs for writes)
#   - Optional network firewall (requires root at startup, hence gosu pattern)
#   - Named volumes for persistence
#   - TOTP sidecar with encrypted file storage
#   - Vault sidecar with encrypted credential storage
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # Main Relay Service
  # ─────────────────────────────────────────────────────────────────────────────
  telclaude:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        USER_UID: 1000
        USER_GID: 1000
    image: telclaude:latest
    container_name: telclaude

    # Wait for sidecars and agent to be ready
    depends_on:
      totp:
        condition: service_healthy
      vault:
        condition: service_healthy
      telclaude-agent:
        condition: service_started

    environment:
      # ── Credentials now live in vault ──────────────────────────────────────
      # Bot token, API keys, OAuth tokens, and RPC keys are stored in vault.
      # Run `telclaude vault import-secrets` and `telclaude vault import-anthropic`
      # to migrate existing credentials.
      #
      # Env var fallbacks (optional, for migration/bootstrap):
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}

      # Moltbook proxy token — agents use this to authenticate with Anthropic proxy
      - MOLTBOOK_PROXY_TOKEN=${MOLTBOOK_PROXY_TOKEN:-}

      # Telclaude configuration (policy + private overlay)
      - TELCLAUDE_CONFIG=/data/telclaude.json
      - TELCLAUDE_PRIVATE_CONFIG=/data/telclaude-private.json
      - TELCLAUDE_DATA_DIR=/data
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}
      # Claude config dir = auth volume (relay-only).
      - CLAUDE_CONFIG_DIR=/home/telclaude-auth
      - TELCLAUDE_CLAUDE_HOME=/home/telclaude-auth
      - TELCLAUDE_AUTH_DIR=/home/telclaude-auth
      - TELCLAUDE_AGENT_URL=http://telclaude-agent:8788
      - TELCLAUDE_SOCIAL_AGENT_URL=http://agent-social:8789
      - TELCLAUDE_CAPABILITIES_ENABLED=1
      # RPC auth — relay holds agent PUBLIC keys (verifies agent→relay) + relay PRIVATE keys (signs relay→agent)
      - TELEGRAM_RPC_AGENT_PUBLIC_KEY=${TELEGRAM_RPC_AGENT_PUBLIC_KEY:-}
      - TELEGRAM_RPC_RELAY_PRIVATE_KEY=${TELEGRAM_RPC_RELAY_PRIVATE_KEY:-}
      - SOCIAL_RPC_AGENT_PUBLIC_KEY=${SOCIAL_RPC_AGENT_PUBLIC_KEY:-}
      - SOCIAL_RPC_RELAY_PRIVATE_KEY=${SOCIAL_RPC_RELAY_PRIVATE_KEY:-}
      # Git proxy session token secret (shared with agent for HMAC validation)
      - TELCLAUDE_GIT_PROXY_SECRET=${TELCLAUDE_GIT_PROXY_SECRET:-}
      - TELCLAUDE_MEDIA_INBOX_DIR=/media/inbox
      - TELCLAUDE_MEDIA_OUTBOX_DIR=/media/outbox

      # TOTP daemon socket (shared with sidecar)
      - TELCLAUDE_TOTP_SOCKET=/run/totp/totp.sock

      # Vault daemon socket (shared with sidecar)
      - TELCLAUDE_VAULT_SOCKET=/run/vault/vault.sock

      # SECURITY: Network firewall REQUIRED (Bash has no isolation without it)
      # Set TELCLAUDE_FIREWALL=1 in .env file (requires --cap-add=NET_ADMIN)
      - TELCLAUDE_FIREWALL=${TELCLAUDE_FIREWALL:-1}
      # Internal hosts allowed through firewall (relay needs to reach agents)
      - TELCLAUDE_INTERNAL_HOSTS=${TELCLAUDE_INTERNAL_HOSTS:-telclaude,telclaude-agent,agent-social}

      # Drop privileges after firewall init (gosu -> node user)
      # Docker mode: SDK sandbox disabled, container provides isolation
      - TELCLAUDE_RUN_AS_ROOT=0

      # Node environment
      - NODE_ENV=production

    volumes:
      # Persistent data (SQLite DB, sessions, config)
      - telclaude-data:/data:rw

      # Configuration files (policy = all containers, private = relay only)
      - ./telclaude.json:/data/telclaude.json:ro
      - ./telclaude-private.json:/data/telclaude-private.json:ro

      # Claude config (auth + skills installed at runtime) — relay-only
      - telclaude-claude-auth:/home/telclaude-auth:rw

      # Shared socket for TOTP daemon communication
      - totp-socket:/run/totp:rw

      # Shared socket for vault daemon communication (relay reads credentials)
      - vault-socket:/run/vault:ro

      # Moltbook memory (relay is single writer)
      - social-memory:/social/memory:rw

      # Shared media volumes (inbox/outbox split)
      - media-inbox:/media/inbox:rw
      - media-outbox:/media/outbox:rw

    # Start as root for firewall init, then drop to node via gosu
    # Docker mode: SDK sandbox disabled, container provides isolation
    user: "0:0"

    # Explicit capability management (no privileged mode)
    # Note: Some kernels (e.g., Raspberry Pi OS) require explicit caps even for root
    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN   # Required for iptables firewall initialization
      - DAC_OVERRIDE  # Required for file access as root on some kernels
      - CHOWN       # Required for changing file ownership
      - FOWNER      # Required for bypassing ownership checks
      - SETUID      # Required for gosu privilege dropping
      - SETGID      # Required for gosu privilege dropping

    security_opt:
      - no-new-privileges:true
      - apparmor:telclaude-relay

    read_only: true
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /home/node:size=256M,mode=0755
      - /run/telclaude:size=1M,mode=0755

    # Resource limits for non-Swarm Docker Compose (deploy.resources is Swarm-only)
    mem_limit: 4G
    cpus: 4

    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 512M

    networks:
      - agent-relay-net
      - relay-totp-net
      - relay-vault-net
      - relay-egress
      - social-relay-net

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8790/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ─────────────────────────────────────────────────────────────────────────────
  # Agent Worker (SDK + Tools, no secrets)
  # ─────────────────────────────────────────────────────────────────────────────
  telclaude-agent:
    build:
      context: ..
      dockerfile: docker/Dockerfile.agent
      args:
        USER_UID: 1000
        USER_GID: 1000
    image: telclaude-agent:latest
    container_name: telclaude-agent


    environment:
      # Agent server
      - TELCLAUDE_AGENT_PORT=8788
      - TELCLAUDE_AGENT_WORKDIR=/workspace
      - TELCLAUDE_CONFIG=/data/telclaude.json
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}

      # Relay capability broker + Anthropic API proxy
      # Agent has NO credentials - all API calls go through relay
      - TELCLAUDE_CAPABILITIES_URL=http://telclaude:8790
      # Use relay proxy for Anthropic API (agent has no credentials)
      - ANTHROPIC_BASE_URL=http://telclaude:8790/v1/anthropic-proxy
      # Internal token used to access the proxy (relay verifies + injects real creds)
      - ANTHROPIC_AUTH_TOKEN=${MOLTBOOK_PROXY_TOKEN:-}
      # RPC auth — agent holds AGENT PRIVATE key (signs agent→relay) + RELAY PUBLIC key (verifies relay→agent)
      - TELEGRAM_RPC_AGENT_PRIVATE_KEY=${TELEGRAM_RPC_AGENT_PRIVATE_KEY:-}
      - TELEGRAM_RPC_RELAY_PUBLIC_KEY=${TELEGRAM_RPC_RELAY_PUBLIC_KEY:-}

      # Git proxy for secure git operations (token never exposed to agent)
      - TELCLAUDE_GIT_PROXY_URL=http://telclaude:8791
      - TELCLAUDE_GIT_PROXY_SECRET=${TELCLAUDE_GIT_PROXY_SECRET:-}

      # Media paths (inbox/outbox split)
      - TELCLAUDE_MEDIA_INBOX_DIR=/media/inbox
      - TELCLAUDE_MEDIA_OUTBOX_DIR=/media/outbox

      # Data dir override (agent is stateless; uses tmpfs instead of /data volume)
      - TELCLAUDE_DATA_DIR=/home/node/.telclaude

      # Claude skills profile (shared with relay)
      - CLAUDE_CONFIG_DIR=/home/telclaude-skills
      - TELCLAUDE_CLAUDE_HOME=/home/telclaude-skills

      # SECURITY: Network firewall for tool egress control (Docker mode)
      - TELCLAUDE_FIREWALL=${TELCLAUDE_FIREWALL:-1}
      # Internal hosts allowed through firewall (agent needs relay + sidecars)
      - TELCLAUDE_INTERNAL_HOSTS=${TELCLAUDE_INTERNAL_HOSTS:-telclaude,telclaude-agent}
      # Skip provider hosts in firewall — agents must route through relay proxy
      - TELCLAUDE_FIREWALL_SKIP_PROVIDERS=1

      # Drop privileges after firewall init
      - TELCLAUDE_RUN_AS_ROOT=0

      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - NODE_ENV=production

    command: ["agent", "-v"]

    volumes:
      # Workspace: Your projects folder (Claude works here)
      - ${WORKSPACE_PATH:?WORKSPACE_PATH is required}:/workspace:rw

      # Policy config (no secrets — providers, network rules, etc.)
      - ./telclaude.json:/data/telclaude.json:ro

      # Claude skills profile (no auth secrets)
      - telclaude-claude-skills:/home/telclaude-skills:rw

      # Moltbook memory (read-only in agent)
      - social-memory:/social/memory:ro

      # Shared media volumes (inbox/outbox split)
      - media-inbox:/media/inbox:ro
      - media-outbox:/media/outbox:ro

    user: "0:0"

    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - DAC_OVERRIDE
      - CHOWN
      - FOWNER
      - SETUID
      - SETGID

    security_opt:
      - no-new-privileges:true
      - apparmor:telclaude-agent

    read_only: true
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /home/node:size=256M,mode=0755,uid=1000,gid=1000
      - /run/telclaude:size=1M,mode=0755

    # Resource limits for non-Swarm Docker Compose (deploy.resources is Swarm-only)
    mem_limit: 4G
    cpus: 4

    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 512M

    networks:
      - agent-relay-net
      - agent-egress

    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────────────────────
  # Social Agent Worker (shared persona for all social services)
  # Part of the generic social services architecture (src/social/).
  # ─────────────────────────────────────────────────────────────────────────────
  agent-social:
    image: telclaude-agent:latest
    container_name: telclaude-agent-social

    environment:
      - TELCLAUDE_AGENT_PORT=8789
      - TELCLAUDE_AGENT_WORKDIR=/social/sandbox
      - TELCLAUDE_CONFIG=/data/telclaude.json
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}
      - TELCLAUDE_CAPABILITIES_URL=http://telclaude:8790
      # Use relay proxy for Anthropic API (agent has no credentials)
      - ANTHROPIC_BASE_URL=http://telclaude:8790/v1/anthropic-proxy
      # Internal token used to access the proxy
      - ANTHROPIC_AUTH_TOKEN=${MOLTBOOK_PROXY_TOKEN:-}
      # Ensure Claude Code state lives under a dedicated public profile
      - HOME=/social
      - CLAUDE_CONFIG_DIR=/home/telclaude-skills
      - TELCLAUDE_CLAUDE_HOME=/home/telclaude-skills
      # Social auth — agent holds AGENT PRIVATE key (signs agent→relay) + RELAY PUBLIC key (verifies relay→agent)
      - SOCIAL_RPC_AGENT_PRIVATE_KEY=${SOCIAL_RPC_AGENT_PRIVATE_KEY:-}
      - SOCIAL_RPC_RELAY_PUBLIC_KEY=${SOCIAL_RPC_RELAY_PUBLIC_KEY:-}
      - TELCLAUDE_DATA_DIR=/home/node/.telclaude
      - TELCLAUDE_FIREWALL=${TELCLAUDE_FIREWALL:-1}
      - TELCLAUDE_FIREWALL_SKIP_PROVIDERS=1
      - TELCLAUDE_RUN_AS_ROOT=0
      - TELCLAUDE_INTERNAL_HOSTS=telclaude
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - NODE_ENV=production

    command: ["agent", "-v"]

    volumes:
      - social-sandbox:/social/sandbox:rw
      - ./telclaude.json:/data/telclaude.json:ro
      - social-memory:/social/memory:ro
      - telclaude-claude-skills:/home/telclaude-skills:rw

    user: "0:0"

    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - DAC_OVERRIDE
      - CHOWN
      - FOWNER
      - SETUID
      - SETGID

    security_opt:
      - no-new-privileges:true
      - apparmor:telclaude-social

    read_only: true
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /home/node:size=256M,mode=0755,uid=1000,gid=1000
      - /run/telclaude:size=1M,mode=0755

    mem_limit: 4G
    cpus: 4

    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 4G
        reservations:
          cpus: "1"
          memory: 512M

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8789/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

    networks:
      - social-relay-net
      - social-egress

    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────────────────────
  # TOTP Daemon Sidecar
  #
  # Handles 2FA operations with encrypted file storage.
  # Communicates with relay via Unix socket on shared volume.
  #
  # SECURITY: Network isolation enforced via internal-only network (relay-totp-net).
  # The TOTP container has NO external network connectivity - it only talks to relay
  # via the shared socket. No iptables/firewall needed since there's no egress route.
  # ─────────────────────────────────────────────────────────────────────────────
  totp:
    build:
      context: ..
      dockerfile: docker/Dockerfile.totp
      args:
        USER_UID: 1000
        USER_GID: 1000
    image: telclaude-totp:latest
    container_name: telclaude-totp

    environment:
      # Storage backend: file (encrypted) instead of keytar (OS keychain)
      - TOTP_STORAGE_BACKEND=file

      # Encryption key for TOTP secrets (REQUIRED)
      # Generate with: openssl rand -base64 32
      - TOTP_ENCRYPTION_KEY=${TOTP_ENCRYPTION_KEY:?TOTP_ENCRYPTION_KEY is required}

      # File paths
      - TOTP_SECRETS_FILE=/data/totp-secrets.json
      - TELCLAUDE_TOTP_SOCKET=/run/totp/totp.sock
      - TELCLAUDE_DATA_DIR=/data
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}

      - NODE_ENV=production

    volumes:
      # Persistent TOTP data (encrypted secrets file)
      - totp-data:/data:rw

      # Shared socket for relay communication
      - totp-socket:/run/totp:rw

    security_opt:
      - no-new-privileges:true

    user: "1000:1000"

    cap_drop:
      - ALL

    read_only: true
    tmpfs:
      - /tmp:size=64M,mode=1777
      - /home/node/.telclaude/logs:size=16M,mode=0755,uid=1000,gid=1000

    # Resource limits for non-Swarm Docker Compose (deploy.resources is Swarm-only)
    mem_limit: 128M
    cpus: 0.5

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M

    networks:
      - relay-totp-net

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "test", "-S", "/run/totp/totp.sock"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # ─────────────────────────────────────────────────────────────────────────────
  # Vault Daemon Sidecar
  #
  # Stores credentials encrypted at rest (AES-256-GCM) and exposes them via
  # Unix socket. The relay's HTTP credential proxy reads from the socket and
  # injects credentials into outbound requests transparently.
  #
  # SECURITY: No external network connectivity (relay-vault-net is internal).
  # The vault container only talks to relay via the shared socket volume.
  # No curl, git, or other utilities installed.
  # ─────────────────────────────────────────────────────────────────────────────
  vault:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vault
      args:
        USER_UID: 1000
        USER_GID: 1000
    image: telclaude-vault:latest
    container_name: telclaude-vault

    environment:
      # Encryption key for credential storage (REQUIRED)
      # Generate with: openssl rand -base64 32
      # IMPORTANT: Keep this safe! If lost, all stored credentials become unrecoverable.
      - VAULT_ENCRYPTION_KEY=${VAULT_ENCRYPTION_KEY:?VAULT_ENCRYPTION_KEY is required}

      # Socket path (shared with relay via volume)
      - TELCLAUDE_VAULT_SOCKET=/run/vault/vault.sock
      - TELCLAUDE_DATA_DIR=/data
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}

      - NODE_ENV=production

    volumes:
      # Persistent vault data (encrypted credentials file)
      - vault-data:/data:rw

      # Shared socket for relay communication
      - vault-socket:/run/vault:rw

    security_opt:
      - no-new-privileges:true
      - apparmor:telclaude-vault

    user: "1000:1000"

    cap_drop:
      - ALL

    read_only: true
    tmpfs:
      - /tmp:size=64M,mode=1777
      - /home/node/.telclaude/logs:size=16M,mode=0755,uid=1000,gid=1000

    # Resource limits for non-Swarm Docker Compose (deploy.resources is Swarm-only)
    mem_limit: 128M
    cpus: 0.5

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M

    networks:
      - relay-vault-net
      - vault-egress  # Required for OAuth2 token refresh (outbound to token endpoints)

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "test", "-S", "/run/vault/vault.sock"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

# ═══════════════════════════════════════════════════════════════════════════════
# Named Volumes
#
# CRITICAL: Some volumes contain secrets that CANNOT be recovered if deleted.
# Run `docker/setup-volumes.sh` before first `docker compose up`.
# NEVER run `docker compose down -v` - it will delete all volumes!
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  # Main relay data: SQLite DB, sessions, identity links, approvals
  telclaude-data:
    name: telclaude-data

  # ┌─────────────────────────────────────────────────────────────────────────────┐
  # │ CRITICAL SECRETS - External volumes (protected from accidental deletion)   │
  # │ These must be pre-created: docker volume create <name>                      │
  # │ `docker compose down -v` CANNOT delete external volumes                     │
  # └─────────────────────────────────────────────────────────────────────────────┘

  # Claude auth profile (OAuth tokens) - relay only
  # Can be recreated via `claude login` but causes service interruption
  telclaude-claude-auth:
    name: telclaude-claude-auth
    external: true

  # TOTP daemon data: encrypted 2FA secrets
  # ⚠️  CANNOT BE RECOVERED IF DELETED - user must re-enroll all 2FA
  totp-data:
    name: telclaude-totp-data
    external: true

  # Vault daemon data: encrypted credentials
  # ⚠️  CANNOT BE RECOVERED IF DELETED - user must re-add all credentials
  vault-data:
    name: telclaude-vault-data
    external: true

  # Shared Unix socket for relay ↔ TOTP communication
  # Uses tmpfs for better performance and automatic cleanup
  totp-socket:
    name: telclaude-totp-socket
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1M,uid=1000,gid=1000

  # Shared Unix socket for relay ↔ vault communication
  # Uses tmpfs for better performance and automatic cleanup
  vault-socket:
    name: telclaude-vault-socket
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1M,uid=1000,gid=1000

  # Shared media inbox (agent RO, relay RW) - size capped
  media-inbox:
    name: telclaude-media-inbox
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=512M,uid=1000,gid=1000,mode=0700

  # Shared media outbox (relay RW, agent RO) - persistent for generated content
  media-outbox:
    name: telclaude-media-outbox

  # Social isolated workspace (agent-social RW)
  social-sandbox:
    name: telclaude-social-sandbox

  # Social shared memory (relay RW, agents RO)
  social-memory:
    name: telclaude-social-memory

  # Claude skills profile (shared across relay/agents)
  telclaude-claude-skills:
    name: telclaude-claude-skills

# ═══════════════════════════════════════════════════════════════════════════════
# Networks
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  agent-relay-net:
    name: telclaude-agent-relay
    driver: bridge
    internal: true

  relay-totp-net:
    name: telclaude-relay-totp
    driver: bridge
    internal: true

  relay-vault-net:
    name: telclaude-relay-vault
    driver: bridge
    internal: true

  agent-egress:
    name: telclaude-agent-egress
    driver: bridge

  relay-egress:
    name: telclaude-relay-egress
    driver: bridge

  social-relay-net:
    name: telclaude-social-relay
    driver: bridge
    internal: true

  social-egress:
    name: telclaude-social-egress
    driver: bridge

  vault-egress:
    name: telclaude-vault-egress
    driver: bridge
