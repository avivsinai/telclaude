# Telclaude Docker Compose - Simple (no TOTP)
# Usage: docker compose -f docker-compose.simple.yml up -d --build

services:
  telclaude:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        USER_UID: 1000
        USER_GID: 1000
    image: telclaude:latest
    container_name: telclaude

    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN is required}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # For secure API key storage (telclaude setup-openai, setup-git)
      # Generate with: openssl rand -base64 32
      - SECRETS_ENCRYPTION_KEY=${SECRETS_ENCRYPTION_KEY:-}
      # API keys (tier-based: auto-exposed for WRITE_LOCAL+)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - TELCLAUDE_CONFIG=/data/telclaude.json
      - TELCLAUDE_DATA_DIR=/data
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}
      # SECURITY: Firewall REQUIRED - set TELCLAUDE_FIREWALL=1 for network isolation
      - TELCLAUDE_FIREWALL=${TELCLAUDE_FIREWALL:-0}
      - TELCLAUDE_RUN_AS_ROOT=1
      - NODE_ENV=production

    volumes:
      - ${WORKSPACE_PATH:?WORKSPACE_PATH is required}:/workspace:rw
      - telclaude-data:/data:rw
      - telclaude-home:/home/node:rw
      - ./telclaude.json:/data/telclaude.json:ro

    # Privileged needed for bubblewrap user namespaces in Docker
    privileged: true

    # Run as root - bubblewrap handles isolation
    user: "0:0"

    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    read_only: true
    tmpfs:
      - /tmp:size=512M,mode=1777

    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 512M

    networks:
      - telclaude-net

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  telclaude-data:
    name: telclaude-data
  telclaude-home:
    name: telclaude-home

networks:
  telclaude-net:
    name: telclaude-net
    driver: bridge
