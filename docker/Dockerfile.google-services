# ═══════════════════════════════════════════════════════════════════════════════
# Telclaude Google Services Sidecar
#
# Fastify REST server providing Gmail, Calendar, Drive, and Contacts access.
# Communicates with the vault via Unix socket for OAuth tokens and approval
# token verification. The relay proxies all agent requests through this sidecar.
#
# SECURITY:
# - Egress is constrained by Docker network policy in compose
# - Reads credentials only from vault via Unix socket
# - Runs as non-root user (node)
# - Read-only root filesystem
# ═══════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────────
# Stage 1: Builder
# ─────────────────────────────────────────────────────────────────────────────────
FROM node:22-bookworm-slim AS builder

# Install build dependencies (needed for better-sqlite3 native module)
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g pnpm@9.15.0

WORKDIR /build

COPY package.json pnpm-lock.yaml .npmrc ./

RUN pnpm install --ignore-scripts

COPY . .

RUN pnpm run build

# Rebuild native modules
RUN pnpm rebuild

# Prune dev dependencies
RUN pnpm prune --prod --ignore-scripts

# ─────────────────────────────────────────────────────────────────────────────────
# Stage 2: Runtime (Minimal)
# ─────────────────────────────────────────────────────────────────────────────────
FROM node:22-bookworm-slim AS runtime

LABEL org.opencontainers.image.title="telclaude-google-services"
LABEL org.opencontainers.image.description="Google services sidecar for telclaude"

ARG USER_UID=1000
ARG USER_GID=1000

RUN groupmod -g ${USER_GID} node \
    && usermod -u ${USER_UID} -g ${USER_GID} node \
    && mkdir -p /home/node \
    && mkdir -p /data \
    && mkdir -p /run/vault \
    && chown -R node:node /home/node /data /run/vault

WORKDIR /app
COPY --from=builder --chown=node:node /build/dist ./dist
COPY --from=builder --chown=node:node /build/node_modules ./node_modules
COPY --from=builder --chown=node:node /build/package.json ./

# Environment
ENV NODE_ENV=production
ENV PORT=3002
ENV TELCLAUDE_VAULT_SOCKET=/run/vault/vault.sock
ENV DATA_DIR=/data
ENV LOG_LEVEL=info
ENV HOME=/home/node

USER node

EXPOSE 3002

HEALTHCHECK --interval=10s --timeout=5s --start-period=10s --retries=3 \
    CMD node -e "fetch('http://localhost:3002/v1/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"

ENTRYPOINT ["node"]
CMD ["dist/google-services/index.js"]
