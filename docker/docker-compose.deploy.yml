# ═══════════════════════════════════════════════════════════════════════════════
# Telclaude Docker Compose - 5-Container Deployment
#
# For deployment targets (Pi4, VPS) with pre-built images.
# Mirrors docker-compose.yml topology, adapted for resource-constrained hosts.
#
# Usage:
#   1. Build images locally:
#        docker build -t telclaude:latest -f docker/Dockerfile .
#        docker build -t telclaude-totp:latest -f docker/Dockerfile.totp .
#        docker build -t telclaude-vault:latest -f docker/Dockerfile.vault .
#   2. Ship to target:
#        docker save telclaude:latest telclaude-totp:latest telclaude-vault:latest \
#          | ssh target "docker load"
#   3. Copy this file, .env, telclaude.json, and telclaude-private.json to target
#   4. Run setup: docker/setup-volumes.sh
#   5. docker compose -f docker-compose.deploy.yml up -d
#
# 5 containers:
#   telclaude        — Relay (secrets, security, routing)
#   telclaude-agent  — Telegram agent (SDK + tools, workspace, browser)
#   agent-social     — Social agent (shared persona, browser)
#   totp             — TOTP sidecar (encrypted 2FA)
#   vault            — Vault sidecar (encrypted credentials)
#
# 7 networks (segmented):
#   agent-relay-net    (internal) — agent ↔ relay
#   relay-totp-net     (internal) — relay ↔ totp
#   relay-vault-net    (internal) — relay ↔ vault
#   agent-egress       (bridge)   — agent → providers/internet
#   relay-egress       (bridge)   — relay → Telegram/Anthropic
#   social-relay-net   (internal) — social ↔ relay
#   social-egress      (bridge)   — social → internet
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # Main Relay Service (secrets, routing — NO workspace, NO SDK)
  # ─────────────────────────────────────────────────────────────────────────────
  telclaude:
    image: telclaude:latest
    container_name: telclaude

    depends_on:
      totp:
        condition: service_healthy
      vault:
        condition: service_healthy
      telclaude-agent:
        condition: service_started

    environment:
      # ── Credentials (vault preferred, env vars as fallback) ───────────────
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
      - MOLTBOOK_PROXY_TOKEN=${MOLTBOOK_PROXY_TOKEN:-}

      # Telclaude configuration (policy + private overlay)
      - TELCLAUDE_CONFIG=/data/telclaude.json
      - TELCLAUDE_PRIVATE_CONFIG=/data/telclaude-private.json
      - TELCLAUDE_DATA_DIR=/data
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}

      # Claude config dir = auth volume (relay-only, no skills needed)
      - CLAUDE_CONFIG_DIR=/home/telclaude-auth
      - TELCLAUDE_CLAUDE_HOME=/home/telclaude-auth
      - TELCLAUDE_AUTH_DIR=/home/telclaude-auth

      # Agent routing
      - TELCLAUDE_AGENT_URL=http://telclaude-agent:8788
      - TELCLAUDE_SOCIAL_AGENT_URL=http://agent-social:8789
      - TELCLAUDE_CAPABILITIES_ENABLED=1

      # RPC auth — relay holds agent PUBLIC keys (verifies agent→relay) + relay PRIVATE keys (signs relay→agent)
      - TELEGRAM_RPC_AGENT_PUBLIC_KEY=${TELEGRAM_RPC_AGENT_PUBLIC_KEY:-}
      - TELEGRAM_RPC_RELAY_PRIVATE_KEY=${TELEGRAM_RPC_RELAY_PRIVATE_KEY:-}
      - SOCIAL_RPC_AGENT_PUBLIC_KEY=${SOCIAL_RPC_AGENT_PUBLIC_KEY:-}
      - SOCIAL_RPC_RELAY_PRIVATE_KEY=${SOCIAL_RPC_RELAY_PRIVATE_KEY:-}
      - TELCLAUDE_GIT_PROXY_SECRET=${TELCLAUDE_GIT_PROXY_SECRET:-}

      # Media paths
      - TELCLAUDE_MEDIA_INBOX_DIR=/media/inbox
      - TELCLAUDE_MEDIA_OUTBOX_DIR=/media/outbox

      # Sidecar sockets
      - TELCLAUDE_TOTP_SOCKET=/run/totp/totp.sock
      - TELCLAUDE_VAULT_SOCKET=/run/vault/vault.sock

      # Network / firewall
      - TELCLAUDE_FIREWALL=${TELCLAUDE_FIREWALL:-1}
      - TELCLAUDE_INTERNAL_HOSTS=${TELCLAUDE_INTERNAL_HOSTS:-telclaude,telclaude-agent,agent-social}
      - TELCLAUDE_ACCEPT_NO_FIREWALL=${TELCLAUDE_ACCEPT_NO_FIREWALL:-0}
      - TELCLAUDE_ALLOW_DEGRADED_PROVIDERS=${TELCLAUDE_ALLOW_DEGRADED_PROVIDERS:-0}

      # Pi4 default: run as root (kernel quirk with gosu on some Pi kernels)
      # Override to 0 in .env for non-Pi deployments to enable privilege drop
      - TELCLAUDE_RUN_AS_ROOT=${TELCLAUDE_RUN_AS_ROOT:-0}
      - NODE_ENV=production

    volumes:
      - telclaude-data:/data:rw
      - ./telclaude.json:/data/telclaude.json:ro
      - ./telclaude-private.json:/data/telclaude-private.json:ro
      - telclaude-claude-auth:/home/telclaude-auth:rw
      - totp-socket:/run/totp:rw
      - vault-socket:/run/vault:ro
      - social-memory:/social/memory:rw
      - media-inbox:/media/inbox:rw
      - media-outbox:/media/outbox:rw
      # NOTE: No workspace mount — relay delegates to agent

    user: "0:0"

    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - DAC_OVERRIDE
      - CHOWN
      - FOWNER
      - SETUID
      - SETGID

    security_opt:
      - no-new-privileges:true
      # AppArmor commented out — profiles may not be installed on Pi
      # - apparmor:telclaude-relay

    read_only: true
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /home/node:size=256M,mode=0755
      - /run/telclaude:size=1M,mode=0755

    # Resource limits (non-Swarm Compose v2)
    mem_limit: 2G
    cpus: 4

    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 256M

    networks:
      - agent-relay-net
      - relay-totp-net
      - relay-vault-net
      - relay-egress
      - social-relay-net

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8790/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ─────────────────────────────────────────────────────────────────────────────
  # Telegram Agent Worker (SDK + Tools, workspace, no secrets)
  # ─────────────────────────────────────────────────────────────────────────────
  telclaude-agent:
    image: telclaude-agent:latest
    container_name: telclaude-agent

    environment:
      # Agent server
      - TELCLAUDE_AGENT_PORT=8788
      - TELCLAUDE_AGENT_WORKDIR=/workspace
      - TELCLAUDE_CONFIG=/data/telclaude.json
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}

      # Relay capability broker + Anthropic API proxy
      - TELCLAUDE_CAPABILITIES_URL=http://telclaude:8790
      - ANTHROPIC_BASE_URL=http://telclaude:8790/v1/anthropic-proxy
      - ANTHROPIC_AUTH_TOKEN=${MOLTBOOK_PROXY_TOKEN:-}

      # RPC auth — agent holds AGENT PRIVATE key (signs agent→relay) + RELAY PUBLIC key (verifies relay→agent)
      - TELEGRAM_RPC_AGENT_PRIVATE_KEY=${TELEGRAM_RPC_AGENT_PRIVATE_KEY:-}
      - TELEGRAM_RPC_RELAY_PUBLIC_KEY=${TELEGRAM_RPC_RELAY_PUBLIC_KEY:-}

      # Git proxy (token never exposed to agent)
      - TELCLAUDE_GIT_PROXY_URL=http://telclaude:8791
      - TELCLAUDE_GIT_PROXY_SECRET=${TELCLAUDE_GIT_PROXY_SECRET:-}

      # Media paths
      - TELCLAUDE_MEDIA_INBOX_DIR=/media/inbox
      - TELCLAUDE_MEDIA_OUTBOX_DIR=/media/outbox

      # Data dir (agent is stateless; uses tmpfs)
      - TELCLAUDE_DATA_DIR=/home/node/.telclaude

      # Claude skills profile (shared)
      - CLAUDE_CONFIG_DIR=/home/telclaude-skills
      - TELCLAUDE_CLAUDE_HOME=/home/telclaude-skills

      # Network / firewall
      - TELCLAUDE_FIREWALL=${TELCLAUDE_FIREWALL:-1}
      - TELCLAUDE_INTERNAL_HOSTS=${TELCLAUDE_INTERNAL_HOSTS:-telclaude,telclaude-agent}
      - TELCLAUDE_FIREWALL_SKIP_PROVIDERS=1

      - TELCLAUDE_RUN_AS_ROOT=0
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - NODE_ENV=production

    command: ["agent", "-v"]

    volumes:
      - ${WORKSPACE_PATH:?WORKSPACE_PATH is required}:/workspace:rw
      - ./telclaude.json:/data/telclaude.json:ro
      - telclaude-claude-skills:/home/telclaude-skills:rw
      - social-memory:/social/memory:ro
      - media-inbox:/media/inbox:ro
      - media-outbox:/media/outbox:ro

    user: "0:0"

    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - DAC_OVERRIDE
      - CHOWN
      - FOWNER
      - SETUID
      - SETGID

    security_opt:
      - no-new-privileges:true
      # AppArmor commented out — profiles may not be installed on Pi
      # - apparmor:telclaude-agent

    read_only: true
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /home/node:size=256M,mode=0755,uid=1000,gid=1000
      - /run/telclaude:size=1M,mode=0755

    # Resource limits (non-Swarm Compose v2)
    mem_limit: 2G
    cpus: 4

    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 256M

    networks:
      - agent-relay-net
      - agent-egress

    restart: unless-stopped

  # ─────────────────────────────────────────────────────────────────────────────
  # Social Agent Worker (shared persona for all social services)
  # Part of the generic social services architecture (src/social/).
  # ─────────────────────────────────────────────────────────────────────────────
  agent-social:
    image: telclaude-agent:latest
    container_name: telclaude-agent-social

    environment:
      - TELCLAUDE_AGENT_PORT=8789
      - TELCLAUDE_AGENT_WORKDIR=/social/sandbox
      - TELCLAUDE_CONFIG=/data/telclaude.json
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}
      - TELCLAUDE_CAPABILITIES_URL=http://telclaude:8790
      - ANTHROPIC_BASE_URL=http://telclaude:8790/v1/anthropic-proxy
      - ANTHROPIC_AUTH_TOKEN=${MOLTBOOK_PROXY_TOKEN:-}
      - HOME=/social
      - CLAUDE_CONFIG_DIR=/home/telclaude-skills
      - TELCLAUDE_CLAUDE_HOME=/home/telclaude-skills
      - SOCIAL_RPC_AGENT_PRIVATE_KEY=${SOCIAL_RPC_AGENT_PRIVATE_KEY:-}
      - SOCIAL_RPC_RELAY_PUBLIC_KEY=${SOCIAL_RPC_RELAY_PUBLIC_KEY:-}
      - TELCLAUDE_DATA_DIR=/home/node/.telclaude
      - TELCLAUDE_FIREWALL=${TELCLAUDE_FIREWALL:-1}
      - TELCLAUDE_FIREWALL_SKIP_PROVIDERS=1
      - TELCLAUDE_RUN_AS_ROOT=0
      - TELCLAUDE_INTERNAL_HOSTS=telclaude
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - NODE_ENV=production

    command: ["agent", "-v"]

    volumes:
      - social-sandbox:/social/sandbox:rw
      - ./telclaude.json:/data/telclaude.json:ro
      - social-memory:/social/memory:ro
      - telclaude-claude-skills:/home/telclaude-skills:rw

    user: "0:0"

    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - DAC_OVERRIDE
      - CHOWN
      - FOWNER
      - SETUID
      - SETGID

    security_opt:
      - no-new-privileges:true
      # AppArmor commented out — profiles may not be installed on Pi
      # - apparmor:telclaude-social

    read_only: true
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /home/node:size=256M,mode=0755,uid=1000,gid=1000
      - /run/telclaude:size=1M,mode=0755

    # Resource limits (non-Swarm Compose v2)
    mem_limit: 1G
    cpus: 2

    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 128M

    networks:
      - social-relay-net
      - social-egress

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8789/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ─────────────────────────────────────────────────────────────────────────────
  # TOTP Daemon Sidecar (encrypted 2FA, no external network)
  # ─────────────────────────────────────────────────────────────────────────────
  totp:
    image: telclaude-totp:latest
    container_name: telclaude-totp

    environment:
      - TOTP_STORAGE_BACKEND=file
      - TOTP_ENCRYPTION_KEY=${TOTP_ENCRYPTION_KEY:?TOTP_ENCRYPTION_KEY is required}
      - TOTP_SECRETS_FILE=/data/totp-secrets.json
      - TELCLAUDE_TOTP_SOCKET=/run/totp/totp.sock
      - TELCLAUDE_DATA_DIR=/data
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}
      - NODE_ENV=production

    volumes:
      - totp-data:/data:rw
      - totp-socket:/run/totp:rw

    security_opt:
      - no-new-privileges:true

    user: "1000:1000"

    cap_drop:
      - ALL

    read_only: true
    tmpfs:
      - /tmp:size=64M,mode=1777
      - /home/node/.telclaude/logs:size=16M,mode=0755,uid=1000,gid=1000

    # Resource limits (non-Swarm Compose v2)
    mem_limit: 128M
    cpus: 0.5

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 32M

    networks:
      - relay-totp-net

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "test", "-S", "/run/totp/totp.sock"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # ─────────────────────────────────────────────────────────────────────────────
  # Vault Daemon Sidecar (encrypted credentials, no external network)
  # ─────────────────────────────────────────────────────────────────────────────
  vault:
    image: telclaude-vault:latest
    container_name: telclaude-vault

    environment:
      - VAULT_ENCRYPTION_KEY=${VAULT_ENCRYPTION_KEY:?VAULT_ENCRYPTION_KEY is required}
      - TELCLAUDE_VAULT_SOCKET=/run/vault/vault.sock
      - TELCLAUDE_DATA_DIR=/data
      - TELCLAUDE_LOG_LEVEL=${TELCLAUDE_LOG_LEVEL:-info}
      - NODE_ENV=production

    volumes:
      - vault-data:/data:rw
      - vault-socket:/run/vault:rw

    security_opt:
      - no-new-privileges:true
      # AppArmor commented out — profiles may not be installed on Pi
      # - apparmor:telclaude-vault

    user: "1000:1000"

    cap_drop:
      - ALL

    read_only: true
    tmpfs:
      - /tmp:size=64M,mode=1777
      - /home/node/.telclaude/logs:size=16M,mode=0755,uid=1000,gid=1000

    # Resource limits (non-Swarm Compose v2)
    mem_limit: 128M
    cpus: 0.5

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 32M

    networks:
      - relay-vault-net

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "test", "-S", "/run/vault/vault.sock"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

# ═══════════════════════════════════════════════════════════════════════════════
# Named Volumes
#
# CRITICAL: Run `docker/setup-volumes.sh` before first `docker compose up`.
# NEVER run `docker compose down -v` - it will delete non-external volumes!
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  # Main relay data: SQLite DB, sessions, identity links, approvals
  telclaude-data:
    name: telclaude-data

  # ┌─────────────────────────────────────────────────────────────────────────────┐
  # │ CRITICAL SECRETS - External volumes (protected from accidental deletion)   │
  # └─────────────────────────────────────────────────────────────────────────────┘

  # Claude auth profile (OAuth tokens) - relay only
  telclaude-claude-auth:
    name: telclaude-claude-auth
    external: true

  # TOTP daemon data: encrypted 2FA secrets
  totp-data:
    name: telclaude-totp-data
    external: true

  # Vault daemon data: encrypted credentials
  vault-data:
    name: telclaude-vault-data
    external: true

  # Shared Unix sockets (tmpfs)
  totp-socket:
    name: telclaude-totp-socket
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1M,uid=1000,gid=1000

  vault-socket:
    name: telclaude-vault-socket
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1M,uid=1000,gid=1000

  # Shared media volumes
  media-inbox:
    name: telclaude-media-inbox
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=512M,uid=1000,gid=1000,mode=0700

  media-outbox:
    name: telclaude-media-outbox

  # Claude skills profile (shared across relay/agents)
  telclaude-claude-skills:
    name: telclaude-claude-skills

  # Social isolated workspace (agent-social RW)
  social-sandbox:
    name: telclaude-social-sandbox

  # Social shared memory (relay RW, agents RO)
  social-memory:
    name: telclaude-social-memory

# ═══════════════════════════════════════════════════════════════════════════════
# Networks (segmented — agents cannot reach each other directly)
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  agent-relay-net:
    name: telclaude-agent-relay
    driver: bridge
    internal: true

  relay-totp-net:
    name: telclaude-relay-totp
    driver: bridge
    internal: true

  relay-vault-net:
    name: telclaude-relay-vault
    driver: bridge
    internal: true

  agent-egress:
    name: telclaude-agent-egress
    driver: bridge

  relay-egress:
    name: telclaude-relay-egress
    driver: bridge

  social-relay-net:
    name: telclaude-social-relay
    driver: bridge
    internal: true

  social-egress:
    name: telclaude-social-egress
    driver: bridge
